<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ข้อมูลสารสนเทศการดื่มนม - โรงเรียนวัดแม่กะ</title>
    
    <!-- ฟอนต์ Sarabun -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React, ReactDOM, Babel, Recharts และ Lucide Icons -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react"></script>

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { 
            LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell 
        } = Recharts;
        const { 
            Search, Users, TrendingUp, Award, Calendar, Filter, AlertCircle, CheckCircle2, XCircle, Loader2, ChevronRight 
        } = lucideReact;

        const App = () => {
            const [activeTab, setActiveTab] = useState('summary');
            const [loading, setLoading] = useState(true);
            const [data, setData] = useState({});
            const [searchTerm, setSearchTerm] = useState('');

            const API_URL = "https://script.google.com/macros/s/AKfycbzi23mZh4IncQVV9vl85idlZz-wBPVtR_vfcJZaqY8vt0lttGwJcW53LybqZbtqm5NL/exec";

            const GRADE_COLORS = ['#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#8B5CF6', '#EC4899'];

            const formatThaiDate = (dateStr) => {
                if (!dateStr || dateStr === "-") return "-";
                try {
                    let date;
                    if (dateStr.includes('/')) {
                        const [d, m, y] = dateStr.split('/').map(Number);
                        date = new Date(y, m - 1, d);
                    } else {
                        date = new Date(dateStr);
                    }
                    if (isNaN(date.getTime())) return dateStr;
                    const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
                    return `${date.getDate().toString().padStart(2, '0')} ${months[date.getMonth()]} ${date.getFullYear() + 543}`;
                } catch (e) { return dateStr; }
            };

            useEffect(() => { fetchData(); }, []);

            const fetchData = async () => {
                setLoading(true);
                try {
                    const response = await fetch(API_URL);
                    const json = await response.json();
                    setData(json);
                } catch (err) {
                    console.error("Fetch error:", err);
                } finally {
                    setLoading(false);
                }
            };

            const allGrades = ['1', '2', '3', '4', '5', '6'];
            
            const stats = useMemo(() => {
                if (!data || Object.keys(data).length === 0) return null;
                let totalStudents = 0, totalEntries = 0, totalMilkConsumed = 0;
                const gradeStats = [], dailyDataMap = {};

                allGrades.forEach(grade => {
                    const students = data[grade] || [];
                    totalStudents += students.length;
                    let gradeConsumed = 0, gradeEntries = 0;
                    students.forEach(student => {
                        Object.keys(student).forEach(key => {
                            if (!['prefix', 'name', 'surname', 'grade'].includes(key)) {
                                gradeEntries++; totalEntries++;
                                if (student[key] === true || student[key] === "TRUE") {
                                    gradeConsumed++; totalMilkConsumed++;
                                    dailyDataMap[key] = (dailyDataMap[key] || 0) + 1;
                                } else { dailyDataMap[key] = (dailyDataMap[key] || 0); }
                            }
                        });
                    });
                    gradeStats.push({ name: `ป.${grade}`, value: gradeEntries > 0 ? (gradeConsumed / gradeEntries) * 100 : 0, count: gradeConsumed, total: gradeEntries });
                });

                const dailyTrend = Object.keys(dailyDataMap).sort((a, b) => {
                    const [d1, m1, y1] = a.split('/').map(Number);
                    const [d2, m2, y2] = b.split('/').map(Number);
                    return new Date(y1, m1 - 1, d1) - new Date(y2, m2 - 1, d2);
                }).map(date => ({ date, percentage: (dailyDataMap[date] / totalStudents) * 100, count: dailyDataMap[date] }));

                return { totalStudents, avgRate: totalEntries > 0 ? (totalMilkConsumed / totalEntries) * 100 : 0, topGrade: [...gradeStats].sort((a, b) => b.value - a.value)[0], gradeComparison: gradeStats, dailyTrend };
            }, [data]);

            const searchResults = useMemo(() => {
                if (!searchTerm) return [];
                const results = [];
                allGrades.forEach(grade => {
                    (data[grade] || []).forEach(s => {
                        if (`${s.prefix}${s.name} ${s.surname}`.includes(searchTerm)) results.push({ ...s, grade: `ป.${grade}` });
                    });
                });
                return results;
            }, [data, searchTerm]);

            const getDatesMissed = (student) => Object.keys(student).filter(key => !['prefix', 'name', 'surname', 'grade'].includes(key) && (student[key] === false || student[key] === "FALSE"));

            const CustomTooltip = ({ active, payload, label }) => {
                if (active && payload && payload.length) {
                    const isGradeChart = payload[0].payload.name?.includes('ป.');
                    return (
                        <div className="bg-white p-4 shadow-lg rounded-lg border border-gray-100">
                            <p className="font-bold text-gray-800 mb-1">{isGradeChart ? payload[0].payload.name : formatThaiDate(label)}</p>
                            <p className="text-red-600 font-bold">{isGradeChart ? `ร้อยละ ${payload[0].value.toFixed(1)}` : `จำนวน: ${payload[0].value} คน`}</p>
                        </div>
                    );
                }
                return null;
            };

            if (loading) return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50">
                    <Loader2 className="animate-spin text-red-600 mb-4" size={48} />
                    <p className="text-gray-600">กำลังประมวลผลข้อมูล...</p>
                </div>
            );

            return (
                <div className="pb-12">
                    <header className="bg-gradient-to-r from-red-700 via-red-600 to-yellow-500 text-white shadow-lg sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row items-center justify-between gap-4">
                            <div className="flex items-center gap-4">
                                <div className="bg-white p-1 rounded-full"><img src="https://img2.pic.in.th/logob0b7643db577ceee.png" className="h-12 w-12 object-contain" /></div>
                                <div>
                                    <h1 className="text-xl md:text-2xl font-bold">ข้อมูลสารสนเทศการดื่มนมของนักเรียน</h1>
                                    <p className="text-red-100 text-sm">โรงเรียนวัดแม่กะ สังกัด สพป.เชียงใหม่ เขต 2</p>
                                </div>
                            </div>
                            <div className="flex items-center bg-white/20 px-4 py-2 rounded-full border border-white/30 text-sm font-bold">
                                <Calendar size={18} className="mr-2" /> {formatThaiDate(new Date().toLocaleDateString('en-GB'))}
                            </div>
                        </div>
                    </header>

                    <nav className="bg-white border-b sticky top-[80px] md:top-[88px] z-40 shadow-sm overflow-x-auto no-scrollbar">
                        <div className="max-w-7xl mx-auto px-4 flex">
                            <button onClick={() => setActiveTab('summary')} className={`px-6 py-4 text-sm font-bold border-b-2 transition-all ${activeTab === 'summary' ? 'border-red-600 text-red-600 bg-red-50/50' : 'border-transparent text-gray-500'}`}>สรุปภาพรวม</button>
                            {allGrades.map(g => <button key={g} onClick={() => setActiveTab(g)} className={`px-6 py-4 text-sm font-bold border-b-2 transition-all ${activeTab === g ? 'border-red-600 text-red-600 bg-red-50/50' : 'border-transparent text-gray-500'}`}>ชั้น ป.{g}</button>)}
                        </div>
                    </nav>

                    <main className="max-w-7xl mx-auto px-4 mt-8">
                        {activeTab === 'summary' ? (
                            <div className="space-y-8">
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                    <div className="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-red-600">
                                        <p className="text-gray-500 text-sm font-medium mb-1">นักเรียนทั้งหมด</p>
                                        <h3 className="text-2xl font-bold">{stats?.totalStudents || 0} คน</h3>
                                    </div>
                                    <div className="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-orange-500">
                                        <p className="text-gray-500 text-sm font-medium mb-1">อัตราการดื่มนมเฉลี่ย</p>
                                        <h3 className="text-2xl font-bold">{stats?.avgRate.toFixed(1) || 0}%</h3>
                                    </div>
                                    <div className="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-yellow-500">
                                        <p className="text-gray-500 text-sm font-medium mb-1">ชั้นที่ดื่มดีที่สุด</p>
                                        <h3 className="text-2xl font-bold">{stats?.topGrade?.name || "-"}</h3>
                                        <p className="text-xs text-gray-400">ร้อยละ {stats?.topGrade?.value.toFixed(1)}</p>
                                    </div>
                                    <div className="bg-yellow-50 p-4 rounded-2xl border border-yellow-200 flex items-center">
                                        <AlertCircle className="text-yellow-600 mr-3 shrink-0" />
                                        <p className="text-xs text-yellow-800">คำนวณจากข้อมูลสะสมทุกวันในระบบ</p>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    <div className="bg-white p-6 rounded-2xl shadow-sm border">
                                        <h3 className="text-lg font-bold mb-6 flex items-center gap-2"><Filter className="text-red-600" size={20} /> สัดส่วนการดื่มนมรายชั้นสะสม (%)</h3>
                                        <div className="h-72">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <BarChart data={stats?.gradeComparison}>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f0f0f0" />
                                                    <XAxis dataKey="name" axisLine={false} tickLine={false} />
                                                    <YAxis hide />
                                                    <Tooltip content={<CustomTooltip />} />
                                                    <Bar dataKey="value" radius={[8, 8, 0, 0]} barSize={40}>
                                                        {stats?.gradeComparison.map((e, i) => <Cell key={i} fill={GRADE_COLORS[i % 6]} />)}
                                                    </Bar>
                                                </BarChart>
                                            </ResponsiveContainer>
                                        </div>
                                    </div>
                                    <div className="bg-white p-6 rounded-2xl shadow-sm border">
                                        <h3 className="text-lg font-bold mb-6 flex items-center gap-2"><TrendingUp className="text-red-600" size={20} /> แนวโน้มการดื่มนมรายวัน</h3>
                                        <div className="h-72">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <LineChart data={stats?.dailyTrend}>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f0f0f0" />
                                                    <XAxis dataKey="date" tickFormatter={(v)=>v.split('/')[0]+'/'+v.split('/')[1]} axisLine={false} tickLine={false} />
                                                    <YAxis hide />
                                                    <Tooltip content={<CustomTooltip />} />
                                                    <Line type="monotone" dataKey="count" stroke="#dc2626" strokeWidth={3} dot={{ r: 4, fill: '#dc2626' }} />
                                                </LineChart>
                                            </ResponsiveContainer>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white rounded-2xl shadow-sm border overflow-hidden">
                                    <div className="p-6 border-b bg-gray-50/50 flex justify-between items-center">
                                        <h3 className="text-lg font-bold">ค้นหาประวัติรายบุคคล</h3>
                                        <Search className="text-gray-400" size={20} />
                                    </div>
                                    <div className="p-6">
                                        <input type="text" placeholder="ค้นหาด้วยชื่อหรือนามสกุล..." className="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-red-500 outline-none" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                                        {searchTerm && (
                                            <div className="mt-6 max-h-80 overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-4">
                                                {searchResults.length > 0 ? searchResults.map((s, idx) => (
                                                    <div key={idx} className="flex items-center justify-between p-4 rounded-xl border hover:bg-red-50 transition-all">
                                                        <div><p className="font-bold">{s.prefix}{s.name} {s.surname}</p><p className="text-xs text-red-500 font-bold">{s.grade}</p></div>
                                                        <div className="flex gap-1 overflow-x-auto max-w-[150px] scrollbar-hide">
                                                            {Object.keys(s).filter(k=>!['prefix','name','surname','grade'].includes(k)).map(k => (
                                                                <div key={k} className={`w-3 h-3 rounded-full shrink-0 ${s[k] === true || s[k] === "TRUE" ? 'bg-green-500' : 'bg-red-500'}`} title={formatThaiDate(k)} />
                                                            ))}
                                                        </div>
                                                    </div>
                                                )) : <p className="col-span-full text-center py-8 text-gray-400">ไม่พบข้อมูล</p>}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-8">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-3xl font-black border-l-8 border-red-600 pl-4">นักเรียนชั้น ป.{activeTab}</h2>
                                    <div className="bg-red-600 text-white px-6 py-2 rounded-full font-bold">นักเรียน {data[activeTab]?.length || 0} คน</div>
                                </div>
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                    <div className="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border">
                                        <h3 className="text-lg font-bold mb-6">กราฟการดื่มนมรายวัน (ป.{activeTab})</h3>
                                        <div className="h-64">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <LineChart data={data[activeTab]?.[0] ? Object.keys(data[activeTab][0]).filter(k=>!['prefix','name','surname'].includes(k)).map(date => ({ date, count: data[activeTab].filter(s=>s[date]===true||s[date]==="TRUE").length })) : []}>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f0f0f0" />
                                                    <XAxis dataKey="date" tickFormatter={(v)=>v.split('/')[0]+'/'+v.split('/')[1]} axisLine={false} tickLine={false} />
                                                    <YAxis hide />
                                                    <Tooltip content={<CustomTooltip />} />
                                                    <Line type="stepAfter" dataKey="count" stroke="#ca8a04" strokeWidth={3} dot={{ r: 4, fill: '#ca8a04' }} />
                                                </LineChart>
                                            </ResponsiveContainer>
                                        </div>
                                    </div>
                                    <div className="bg-gradient-to-br from-red-600 to-red-800 text-white p-8 rounded-2xl shadow-xl text-center flex flex-col justify-center">
                                        <CheckCircle2 size={48} className="mx-auto mb-4 text-red-200" />
                                        <h4 className="text-xl font-bold">สรุปวันล่าสุด</h4>
                                        <p className="text-yellow-300 font-bold mb-2">
                                            {(() => {
                                                const s = data[activeTab] || [];
                                                if (s.length === 0) return "-";
                                                const d = Object.keys(s[0]).filter(k=>!['prefix','name','surname'].includes(k));
                                                return formatThaiDate(d[d.length - 1]);
                                            })()}
                                        </p>
                                        <div className="text-5xl font-black mb-4">
                                            {(() => {
                                                const s = data[activeTab] || [];
                                                if (s.length === 0) return "0/0";
                                                const d = Object.keys(s[0]).filter(k=>!['prefix','name','surname'].includes(k));
                                                const last = d[d.length - 1];
                                                return `${s.filter(st=>st[last]===true||st[last]==="TRUE").length}/${s.length}`;
                                            })()}
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white rounded-2xl shadow-sm border overflow-hidden">
                                    <div className="p-6 border-b flex items-center justify-between bg-gray-50/50">
                                        <h3 className="text-lg font-bold flex items-center gap-2"><XCircle className="text-red-600" /> รายชื่อนักเรียนที่ไม่ได้ดื่มนม</h3>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left">
                                            <thead className="bg-gray-100 text-gray-500 uppercase text-xs font-bold">
                                                <tr><th className="px-6 py-4">ลำดับ</th><th className="px-6 py-4">ชื่อ-นามสกุล</th><th className="px-6 py-4">จำนวนวันที่ขาด</th><th className="px-6 py-4">วันที่ไม่ได้ดื่ม</th></tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {data[activeTab]?.filter(s => getDatesMissed(s).length > 0).map((s, idx) => (
                                                    <tr key={idx} className="hover:bg-gray-50 transition-all">
                                                        <td className="px-6 py-4 text-gray-400 font-medium">{idx + 1}</td>
                                                        <td className="px-6 py-4 font-bold text-gray-800">{s.prefix}{s.name} {s.surname}</td>
                                                        <td className="px-6 py-4"><span className="text-red-600 font-black">ขาด {getDatesMissed(s).length} วัน</span></td>
                                                        <td className="px-6 py-4">
                                                            <div className="flex flex-wrap gap-2">
                                                                {getDatesMissed(s).map((d, dIdx) => (
                                                                    <span key={dIdx} className="text-[10px] bg-red-50 text-red-600 px-2 py-1 rounded-md border border-red-100 font-bold">{formatThaiDate(d)}</span>
                                                                ))}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                    <footer className="mt-16 text-center text-gray-400 text-sm border-t pt-8 pb-8"><p>© โรงเรียนวัดแม่กะ</p></footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
